version: '3.8'

services:
  db:
    image: postgres:16-alpine
    container_name: cortexex_db
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cortexex_network
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cortexex_backend
    environment:
      PORT: 5000
      DATABASE_URL: "postgresql://${DB_USER}:${DB_PASSWORD}@db:5432/${DB_NAME}"
      FRONTEND_URL: ${FRONTEND_URL:-https://whereitleads.io}
      NODE_ENV: production
    depends_on:
      db:
        condition: service_healthy
    networks:
      - cortexex_network
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_BASE_PATH: ${NEXT_PUBLIC_BASE_PATH:-/cortexex}
    container_name: cortexex_frontend
    environment:
      HOSTNAME: "0.0.0.0"
      PORT: 3000
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://whereitleads.io/api}
      NEXT_PUBLIC_BASE_PATH: ${NEXT_PUBLIC_BASE_PATH:-/cortexex}
      NODE_ENV: production
    depends_on:
      - backend
    networks:
      - cortexex_network
    restart: unless-stopped

  backup:
    image: postgres:16-alpine
    container_name: cortexex_backup
    environment:
      PGHOST: db
      PGPORT: 5432
      PGUSER: ${DB_USER:-cortexex}
      PGPASSWORD: ${DB_PASSWORD:-cortexex_password}
      PGDATABASE: ${DB_NAME:-cortexex}
    volumes:
      - ./backups:/backups
      - ./backend/scripts/backup.sh:/backup.sh
      - ./backend/scripts/crontab:/etc/cron.d/backup
    command: sh -c "chmod +x /backup.sh && chmod 0644 /etc/cron.d/backup && crond -f -l 2"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - cortexex_network
    restart: unless-stopped

volumes:
  postgres_data:

networks:
  cortexex_network:
    driver: bridge
